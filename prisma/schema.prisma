// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============= ENUMS =============

enum UserRole {
  OWNER
  ADMIN
  PROJECT_MANAGER
  DEVELOPER
  SUPPORT
  FINANCE
  PARTNER_MANAGER
}

enum ClientStatus {
  LEAD
  ACTIVE
  PAUSED
  CLOSED
}

enum ProjectStatus {
  DISCOVERY
  IN_PROGRESS
  REVIEW
  PRODUCTION
  PAUSED
  CLOSED
}

enum ProjectUpdateType {
  NOTE
  STATUS_CHANGE
  MILESTONE
}

enum TicketStatus {
  NEW
  IN_PROGRESS
  WAITING_CLIENT
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
}

enum TicketSource {
  MANUAL
  AUTOMATION
  CLIENT_PORTAL
  MONITORING
}

enum TicketUpdateType {
  NOTE
  STATUS_CHANGE
  INCIDENT
}

enum TicketWatcherType {
  CLIENT
  INTERNAL
}

enum PartnerStatus {
  ACTIVE
  PAUSED
  INACTIVE
}

enum PartnerType {
  AGENCY
  FREELANCER
  AFFILIATE
  INTERNAL_SALES
}

enum PartnerReferralStatus {
  PENDING
  WON
  LOST
}

enum PayoutStatus {
  PENDING
  PAID
  CANCELLED
}

// ============= MODELS =============

model User {
  id            String   @id @default(cuid())
  name          String
  email         String   @unique
  role          UserRole
  timezone      String   @default("UTC")
  passwordHash  String

  projectsManaged   Project[]   @relation("ProjectManager")
  ticketsAssigned   Ticket[]    @relation("TicketAssignee")
  ticketUpdates     TicketUpdate[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Client {
  id            String        @id @default(cuid())
  name          String
  contactName   String?
  contactEmail  String?
  phone         String?
  country       String?
  timezone      String?
  industry      String?
  notes         String?
  status        ClientStatus  @default(LEAD)

  projects      Project[]
  tickets       Ticket[]
  invoices      Invoice[]
  referrals     PartnerReferral[]
  accesses      ClientAccess[]

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model Project {
  id            String        @id @default(cuid())
  name          String
  type          String
  status        ProjectStatus @default(DISCOVERY)
  clientId      String
  client        Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)

  managerId     String?
  manager       User?         @relation("ProjectManager", fields: [managerId], references: [id], onDelete: SetNull)

  description   String?
  startDate     DateTime?
  dueDate       DateTime?

  tickets       Ticket[]
  invoices      Invoice[]
  referrals     PartnerReferral[]
  updates       ProjectUpdate[] @relation("ProjectUpdates")

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model Ticket {
  id            String         @id @default(cuid())
  ticketNumber  Int            @unique @default(autoincrement())
  title         String
  description   String?
  status        TicketStatus   @default(NEW)
  priority      TicketPriority @default(MEDIUM)
  source        TicketSource   @default(MANUAL)
  serviceArea   String?
  environment   String?
  notifyClient  Boolean        @default(true)
  lastClientNotifAt DateTime?
  dueAt         DateTime?
  closedAt      DateTime?

  clientId      String?
  client        Client?        @relation(fields: [clientId], references: [id], onDelete: SetNull)

  projectId     String?
  project       Project?       @relation(fields: [projectId], references: [id], onDelete: SetNull)

  assigneeId    String?
  assignee      User?          @relation("TicketAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)

  updates       TicketUpdate[]
  watchers      TicketWatcher[]

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model TicketUpdate {
  id             String           @id @default(cuid())
  ticketId       String
  ticket         Ticket           @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  type           TicketUpdateType @default(NOTE)
  message        String
  previousStatus TicketStatus?
  nextStatus     TicketStatus?
  public         Boolean          @default(false)
  notifyClient   Boolean          @default(false)

  authorId       String?
  author         User?            @relation(fields: [authorId], references: [id], onDelete: SetNull)
  authorName     String?
  authorEmail    String?

  createdAt      DateTime         @default(now())
}

model TicketWatcher {
  id        String            @id @default(cuid())
  ticketId  String
  ticket    Ticket            @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  type      TicketWatcherType @default(CLIENT)
  email     String
  name      String?
  createdAt DateTime          @default(now())
}

model Invoice {
  id            String        @id @default(cuid())
  clientId      String
  client        Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)

  projectId     String?
  project       Project?      @relation(fields: [projectId], references: [id], onDelete: SetNull)

  amount        Float
  currency      String        @default("EUR")
  description   String?
  issueDate     DateTime      @default(now())
  dueDate       DateTime?
  status        InvoiceStatus @default(DRAFT)

  referralId    String?
  referral      PartnerReferral? @relation(fields: [referralId], references: [id], onDelete: SetNull)

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model ProjectUpdate {
  id          String            @id @default(cuid())
  projectId   String
  project     Project           @relation("ProjectUpdates", fields: [projectId], references: [id], onDelete: Cascade)
  type        ProjectUpdateType @default(NOTE)
  title       String?
  message     String
  authorName  String?
  authorEmail String?
  notifyTeam  Boolean           @default(false)
  createdAt   DateTime          @default(now())
}

// ============= TEAM MANAGEMENT =============

model TeamRole {
  id        String        @id @default(cuid())
  name      String
  color     String        @default("#2563EB")
  members   TeamMember[]
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}

model TeamMember {
  id                   String   @id @default(cuid())
  name                 String
  email                String   @unique
  roleId               String?
  role                 TeamRole? @relation(fields: [roleId], references: [id], onDelete: SetNull)
  location             String?
  timezone             String   @default("America/Argentina/Buenos_Aires")
  phone                String?
  slackHandle          String?
  preferredChannel     String?
  availability         String?
  focusAreas           String[] @default([])
  responsibilities     String[] @default([])
  notes                String?
  isEscalationContact  Boolean  @default(false)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

// ============= PARTNERS =============

model Partner {
  id              String           @id @default(cuid())
  name            String
  type            PartnerType      @default(AFFILIATE)
  status          PartnerStatus    @default(ACTIVE)

  contactName     String?
  contactEmail    String?
  contactPhone    String?

  trackingCode    String?          @unique
  baseCommissionRate Float?

  referrals       PartnerReferral[]
  payouts         PartnerPayout[]

  notes           String?

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
}

model PartnerReferral {
  id              String                @id @default(cuid())
  partnerId       String
  partner         Partner               @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  clientId        String?
  client          Client?               @relation(fields: [clientId], references: [id], onDelete: SetNull)

  projectId       String?
  project         Project?              @relation(fields: [projectId], references: [id], onDelete: SetNull)

  status          PartnerReferralStatus @default(PENDING)
  commissionRate  Float?
  commissionBase  Float?
  commissionAmount Float?
  currency        String?              @default("EUR")

  invoices        Invoice[]
  payouts         PartnerPayout[]

  notes           String?
  
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
}

model PartnerPayout {
  id              String       @id @default(cuid())
  partnerId       String
  partner         Partner      @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  referralId      String?
  referral        PartnerReferral? @relation(fields: [referralId], references: [id], onDelete: SetNull)

  amount          Float
  currency        String       @default("EUR")
  status          PayoutStatus @default(PENDING)
  payoutDate      DateTime?
  method          String?

  notes           String?

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
}

model ClientAccess {
  id          String   @id @default(cuid())
  clientId    String
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  service     String
  username    String?
  password    String?
  url         String?
  notes       String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
